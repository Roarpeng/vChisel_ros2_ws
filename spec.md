# vChisel 工业视觉凿击系统 - 产品规格说明书

## 1. 项目概述

### 1.1 产品定位
vChisel 是一套面向**混凝土建材行业**的工业自动化视觉凿击系统，用于清理混凝土预制件表面的突出物（如模具拼缝流淤、气泡凸起等）。系统集成深度相机、点云处理算法和西门子PLC通信，实现从视觉感知到工业执行的完整闭环控制。

### 1.2 当前状态
| 模块 | 状态 | 说明 |
|------|------|------|
| 点云处理核心 | ✅ 已完成 | 双模式选点算法、凸起处理策略 |
| PLC通信 | ✅ 已完成 | Snap7协议、状态机交互 |
| 相机监控 | ✅ 已完成 | 自动重连机制 |
| 手眼标定 | ⏳ 待完成 | 需要向导式自动标定界面 |
| 参数动态调整 | ⏳ 待完成 | 需要配方管理和自学习功能 |
| 客户UI | ⏳ 待完成 | 操作员界面、工控机桌面应用 |

---

## 2. 应用场景

### 2.1 工况描述
- **工件类型**: 混凝土预制件（墙板、楼板、梁柱等）
- **处理对象**: 表面突出物（模具拼缝处的混凝土流淤、气泡凸起、粗糙表面）
- **工艺目的**: 通过凿击清理表面缺陷，保证预制件表面质量

### 2.2 当前网格布局
- **网格规格**: 4行 × 6列 = 24个凿击点位
- **网格尺寸**: 每格50mm × 50mm
- **工作范围**: X: -150mm~150mm, Y: -100mm~100mm, Z: 200mm~800mm

### 2.3 凸起处理策略
当检测到凸起（Z轴极差 > 2cm）时，采用"半山腰"选点策略：
- 削掉顶部25%（避免凿头打滑）
- 削掉底部10%（避免过度深入）
- 在中间区域选择最佳凿击点

---

## 3. 待开发功能需求

### 3.1 手眼标定系统

#### 3.1.1 标定频率要求
- **正常情况**: 一次标定长期使用，设备安装后标定一次即可
- **重新标定场景**: 相机更换、机器人调整、严重碰撞后
- **精度要求**: mm级别（具体精度待现场验证）

#### 3.1.2 功能需求
| 功能 | 优先级 | 描述 |
|------|--------|------|
| 向导式标定界面 | P0 | 引导用户完成标定流程，降低操作难度 |
| 标定数据备份 | P0 | 支持标定矩阵的导出、导入和恢复 |
| 标定质量评估 | P1 | 显示标定误差、重投影误差等指标 |
| 标定历史记录 | P2 | 记录历次标定时间和结果 |

#### 3.1.3 标定流程设计
```
1. 选择标定模式（首次标定/重新标定/验证标定）
2. 引导用户放置标定板
3. 触发PLC，从PLC读取当前机器人末端位姿（hand_data）
4. 同时通过相机检测标定板位姿（eye_data）
5. 重复步骤3-4，采集多组位姿数据（建议8-15组）
6. 计算手眼标定矩阵（Eye-in-Hand或Eye-to-Hand）
7. 显示标定质量报告（重投影误差等）
8. 确认并保存标定结果
9. 自动备份到配置文件
```

#### 3.1.4 机器人位姿获取
- **数据来源**: 通过Snap7从PLC读取机器人当前位姿
- **数据格式**: 6个REAL值（X, Y, Z, RX, RY, RZ）或4x4变换矩阵
- **触发方式**: UI发送标定采集命令 → PLC返回当前位姿
- **同步要求**: 确保相机拍摄时机器人静止，位姿数据与图像时间同步

---

### 3.2 参数动态调整系统

#### 3.2.1 配方管理

**配方规模**: 少量固定（不超过10种）

**每个配方包含的参数**:
| 参数类别 | 参数项 | 说明 |
|----------|--------|------|
| 区域设置 | BOX_LEN, BOX_ROW, BOX_COLUMN | 网格划分 |
| 范围限制 | XMIN/XMAX, YMIN/YMAX, ZMIN/ZMAX | 工作空间 |
| 严格模式 | STRICT_NORM_TH, STRICT_HOLE_DIST, STRICT_CURV_TH | 高质量选点 |
| 宽松模式 | RELAXED_NORM_TH, RELAXED_HOLE_DIST, RELAXED_CURV_TH | 降级选点 |
| 评分权重 | HEIGHT_WEIGHT, CURV_WEIGHT, ANGLE_WEIGHT, CENTER_WEIGHT | 选点评分 |
| 凸起处理 | PROTRUSION_TH, TIP_CROP_RATIO, BASE_CROP_RATIO | 凸起策略 |

**配方管理功能**:
| 功能 | 优先级 | 描述 |
|------|--------|------|
| 配方库管理 | P0 | 创建、编辑、删除、复制配方 |
| 配方切换 | P0 | 从配方库选择并加载参数 |
| 配方版本管理 | P1 | 修改历史、版本回滚 |
| 配方导入导出 | P1 | 备份和迁移配方数据 |

#### 3.2.2 自学习优化

**目标**: 基于历史数据自动优化参数权重

**自学习范围**:
- 参数权重优化（HEIGHT_WEIGHT, CURV_WEIGHT等的自动调整）

**实现思路**:
```
1. 记录每次凿击的选点参数和结果反馈
2. 分析哪些参数组合导致更好的凿击效果
3. 基于统计分析提供参数调整建议
4. 支持一键应用优化建议或手动确认
```

**暂不实现**:
- 工件类型自动识别
- 模式策略自动切换
- 实时在线学习

---

### 3.3 客户UI系统

#### 3.3.1 部署形态
- **运行环境**: 工控机桌面应用
- **操作方式**: 鼠标/键盘操作（非触摸屏）
- **网络环境**: 局域网连接，无外网需求
- **系统集成**: 暂不需要MES/SCADA集成

#### 3.3.2 用户角色
| 角色 | 权限 | 典型操作 |
|------|------|----------|
| 操作员 | 基础 | 启停控制、配方切换、状态监控 |
| 维护人员 | 中级 | 故障诊断、手动控制、日志查看 |
| 工艺工程师 | 高级 | 参数调整、配方管理、统计分析 |

#### 3.3.3 操作员界面功能

**核心操作**:
| 功能 | 优先级 | 描述 |
|------|--------|------|
| 系统启停 | P0 | 启动/停止自动运行 |
| 配方选择 | P0 | 从配方库加载工件参数 |
| 状态监控 | P0 | 显示当前系统状态、处理进度 |
| 故障提示 | P0 | 显示故障信息和处理建议 |

**监控显示**:
| 内容 | 优先级 | 描述 |
|------|--------|------|
| 运行状态 | P0 | 待机/运行/故障/恢复中 |
| 处理计数 | P0 | 当前批次处理数量 |
| 故障信息 | P0 | 最近故障及处理状态 |
| 实时图像 | P2 | 可选显示相机画面（非必需） |

#### 3.3.4 报警机制
| 报警方式 | 支持 | 说明 |
|----------|------|------|
| 屏幕显示 | ✅ | 弹窗提示、状态栏显示 |
| PLC联动 | ✅ | 同步报警状态到PLC/HMI |
| 声光报警 | ❌ | 由PLC侧控制 |
| 远程通知 | ❌ | 暂不需要 |

**报警分级**:
| 级别 | 名称 | 处理方式 | 示例 |
|------|------|----------|------|
| Info | 信息 | 仅记录 | 配方切换成功 |
| Warning | 警告 | 显示提示 | 网格选点失败率较高 |
| Error | 错误 | 需要确认 | 相机断开已重连 |
| Fatal | 故障 | 停机处理 | 多次重连失败 |

---

### 3.4 系统可靠性

#### 3.4.1 故障自动恢复

**设计原则**: 自动恢复优先，减少停机时间

| 故障场景 | 恢复策略 | 最大恢复时间 | 失败处理 |
|----------|----------|--------------|----------|
| 相机断开 | 自动重连（最多5次） | 10秒 | 报警+等待人工 |
| PLC通信超时 | 自动重连 | 5秒 | 报警+等待人工 |
| 点云处理失败 | 重试1次 | 当前周期 | 跳过当前工件 |
| 内存/资源泄露 | 定期检查+自动重启 | 后台执行 | 预警通知 |

#### 3.4.2 异常点位保护

**保护机制**:
| 保护项 | 优先级 | 描述 |
|--------|--------|------|
| 边界检测 | P0 | 点位超出工件范围时自动跳过 |
| 群体合理性检查 | P0 | 检测凿击点群的分布是否合理 |
| 禁凿区域 | P2 | 预定义不可凿击区域（如预埋件位置） |
| 密度异常检测 | P2 | 连续凿击点距离过近时警告 |

#### 3.4.3 资源泄露防护
```
- 定期监控内存使用量
- 点云数据及时释放
- 长时间运行后的健康检查
- 异常增长时自动告警
```

---

### 3.5 统计与追溯

#### 3.5.1 故障统计

**统计项目**:
| 统计项 | 描述 | 用途 |
|--------|------|------|
| 相机连接故障 | 断开次数、重连成功率、平均恢复时间 | 硬件健康监控 |
| PLC通信故障 | 超时次数、通信失败率 | 网络稳定性评估 |
| 选点失败统计 | 严格模式失败率、宽松模式失败率、跳过网格数 | 工艺参数优化 |

**统计周期**: 班次/日/周/月

#### 3.5.2 参数变更历史
```
- 记录每次配方修改的时间、操作人、修改内容
- 支持配方版本对比
- 支持回滚到历史版本
```

#### 3.5.3 数据存储
| 数据类型 | 存储策略 | 保留周期 |
|----------|----------|----------|
| 故障日志 | 本地SQLite/文件 | 3个月 |
| 统计报表 | 本地SQLite | 1年 |
| 配方历史 | 本地文件 | 永久 |
| 原始点云/图像 | ❌ 不存储 | - |

---

### 3.6 版本与部署

#### 3.6.1 部署方式
- **形态**: 安装包部署（非容器化）
- **目标**: 预编译deb包或安装脚本
- **网络**: 离线安装，无需外网

#### 3.6.2 版本管理
| 管理项 | 支持 | 描述 |
|--------|------|------|
| 配方版本管理 | ✅ | 修改历史、版本回滚 |
| 软件版本记录 | ✅ | 系统版本号、更新日志 |
| 标定数据备份 | ✅ | 导出/导入标定矩阵 |
| 多站点同步 | ❌ | 单机独立运行 |

---

## 4. 性能要求

### 4.1 处理时间
| 阶段 | 目标时间 | 说明 |
|------|----------|------|
| 单次处理总时间 | < 5秒 | 从PLC请求到返回点位 |
| 点云采集 | < 1秒 | 相机拍摄+数据传输 |
| 点云处理 | < 2秒 | 滤波+法向估计+选点 |
| 通信开销 | < 0.5秒 | PLC读写 |

### 4.2 稳定性要求
- 24/7连续运行
- 平均无故障时间(MTBF) > 24小时
- 故障自动恢复率 > 90%

---

## 5. 技术架构建议

### 5.1 UI技术选型
考虑工控机桌面应用场景，**优先采用方案B**：
- **方案B (推荐)**: Electron + Web - 界面美观，跨平台能力强，前后端分离便于维护
- **方案A**: PyQt5/PyQt6 - 与现有Python代码集成简单
- **方案C**: ROS2 rqt插件 - 与ROS生态集成紧密

### 5.2 数据存储
- **配置文件**: YAML格式（沿用现有方案）
- **配方数据**: JSON文件 + 版本目录
- **统计数据**: SQLite本地数据库
- **日志系统**: ROS2日志 + 结构化日志文件

### 5.3 进程架构
```
┌─────────────────────────────────────────────┐
│                 操作员UI                      │
│  (PyQt5/Electron)                           │
├─────────────────────────────────────────────┤
│                 ROS2中间件                    │
├──────────────┬──────────────┬───────────────┤
│ norm_calc    │ snap_7       │ calibration   │
│ 点云处理      │ PLC通信       │ 标定服务       │
├──────────────┴──────────────┴───────────────┤
│              硬件抽象层                       │
│  RealSense相机  │  Snap7 PLC  │  机械臂       │
└─────────────────────────────────────────────┘
```

---

## 6. 开发优先级

### Phase 1: 核心功能完善
1. **P0**: 向导式手眼标定界面
2. **P0**: 配方管理基础功能（创建/编辑/切换）
3. **P0**: 操作员UI基础版（启停/状态/配方选择）

### Phase 2: 可靠性增强
4. **P1**: 故障自动恢复机制完善
5. **P1**: 异常点位保护（边界检测+合理性检查）
6. **P1**: 配方版本管理

### Phase 3: 统计与优化
7. **P2**: 故障统计报表
8. **P2**: 参数自学习建议功能
9. **P2**: 标定数据备份恢复

---

## 7. 附录

### 7.1 现有代码结构
```
src/
├── norm_calc/          # 点云处理包 (C++)
│   ├── src/
│   │   ├── norm_calc_server.cpp   # 主服务节点
│   │   ├── chisel_box.cpp         # 凿击点选择算法
│   │   └── hole_detector.cpp      # 孔洞检测
│   └── config/
│       └── norm_calc_params.yaml  # 参数配置
├── snap_7/             # PLC通信包 (Python)
│   └── snap_7/
│       ├── plc_client_node.py     # PLC客户端
│       └── camera_monitor.py      # 相机监控
└── hand_eye_calib/     # 手眼标定包 (C++/Python)
    └── src/
        └── hand_eye_calib_srv.cpp # 标定服务
```

### 7.2 关键接口
```
服务: /norm_calc (NormCalcData)
  请求: uint32 seq
  响应: geometry_msgs/PoseArray pose_list

话题: /camera_status (std_msgs/Bool)
话题: /debug_processed_cloud (PointCloud2)
话题: /visual_norm_result (PoseArray)
```

### 7.3 PLC通信协议
| 偏移地址 | 类型 | 方向 | 用途 |
|---------|------|------|------|
| 0-2 | INT | 读 | plcStatus触发值 |
| 16 | INT | 写 | rosStatus状态码 |
| 18 | INT | 写 | pointNum点位数量 |
| 20-592 | REAL[] | 写 | 24个位姿数据(每个6值) |

---

*文档版本: 1.0*
*生成日期: 2026-01-04*
*基于需求访谈整理*
